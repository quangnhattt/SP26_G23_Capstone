name: CI/CD Pipeline (Smart Build)

on:
  push:
    branches:
      - main
      - master
      - UAT
      - develop
  pull_request:
    branches:
      - main
      - master
      - UAT

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/agms

jobs:
  # Detect Changes - Kiểm tra file nào thay đổi
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.event.before }}
          filters: |
            backend:
              - 'BE/**'
            frontend:
              - 'FE/**'
            workflows:
              - '.github/workflows/**'

      - name: Show detected changes
        run: |
          echo "Backend changed: ${{ steps.filter.outputs.backend }}"
          echo "Frontend changed: ${{ steps.filter.outputs.frontend }}"
          echo "Workflows changed: ${{ steps.filter.outputs.workflows }}"

  # Build và Test Backend (chỉ khi có thay đổi)
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/AGMS.sln', '**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        working-directory: ./BE/src/AGMS
        run: dotnet restore

      - name: Build
        working-directory: ./BE/src/AGMS
        run: dotnet build --configuration Release --no-restore

      - name: Test
        working-directory: ./BE/src/AGMS
        run: dotnet test --no-restore --verbosity normal

  # Build và Test Frontend (chỉ khi có thay đổi)
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './FE/web-advanced-garage-management-system/package-lock.json'

      - name: Install dependencies
        working-directory: ./FE/web-advanced-garage-management-system
        run: npm ci

      - name: Lint
        working-directory: ./FE/web-advanced-garage-management-system
        run: npm run lint

      - name: Build
        working-directory: ./FE/web-advanced-garage-management-system
        run: npm run build

  # Build và Push Backend Docker Image (chỉ khi Backend thay đổi)
  build-and-push-backend:
    name: Build and Push Backend Image
    runs-on: ubuntu-latest
    needs: [detect-changes, build-backend]
    if: |
      always() &&
      github.event_name == 'push' &&
      (github.ref_name == 'main' || github.ref_name == 'master' || github.ref_name == 'UAT') &&
      needs.detect-changes.outputs.backend == 'true' &&
      needs.build-backend.result == 'success'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./BE/src/AGMS
          file: ./BE/src/AGMS/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build và Push Frontend Docker Image (chỉ khi Frontend thay đổi)
  build-and-push-frontend:
    name: Build and Push Frontend Image
    runs-on: ubuntu-latest
    needs: [detect-changes, build-frontend]
    if: |
      always() &&
      github.event_name == 'push' &&
      (github.ref_name == 'main' || github.ref_name == 'master' || github.ref_name == 'UAT') &&
      needs.detect-changes.outputs.frontend == 'true' &&
      needs.build-frontend.result == 'success'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./FE/web-advanced-garage-management-system
          file: ./FE/web-advanced-garage-management-system/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy to Server
  deploy:
    name: Deploy to Ubuntu Server
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-push-backend, build-and-push-frontend]
    if: |
      always() &&
      github.event_name == 'push' &&
      (github.ref_name == 'main' || github.ref_name == 'master' || github.ref_name == 'UAT') &&
      (needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.frontend == 'true') &&
      (needs.build-and-push-backend.result == 'success' || needs.build-and-push-frontend.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment configuration
        id: config
        run: |
          if [[ "${{ github.ref_name }}" == "UAT" ]]; then
            echo "compose_file=docker-compose.uat.yml" >> $GITHUB_OUTPUT
            echo "backend_port=9001" >> $GITHUB_OUTPUT
            echo "frontend_port=3001" >> $GITHUB_OUTPUT
            echo "env_name=UAT" >> $GITHUB_OUTPUT
          else
            echo "compose_file=docker-compose.prod.yml" >> $GITHUB_OUTPUT
            echo "backend_port=9000" >> $GITHUB_OUTPUT
            echo "frontend_port=3000" >> $GITHUB_OUTPUT
            echo "env_name=Production" >> $GITHUB_OUTPUT
          fi

      - name: Copy files to server (UAT)
        if: github.ref_name == 'UAT'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "docker-compose.backend.uat.yml,docker-compose.frontend.uat.yml,.github/scripts/deploy.sh"
          target: ${{ secrets.DEPLOY_PATH || '/opt/agms' }}
          strip_components: 2

      - name: Copy files to server (Production)
        if: github.ref_name  == 'master'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "docker-compose.backend.prod.yml,docker-compose.frontend.prod.yml,.github/scripts/deploy.sh"
          target: ${{ secrets.DEPLOY_PATH || '/opt/agms' }}
          strip_components: 2

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          BACKEND_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ github.ref_name }}
          FRONTEND_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ github.ref_name }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/opt/agms' }}
          ENV_NAME: ${{ steps.config.outputs.env_name }}
          BACKEND_PORT: ${{ steps.config.outputs.backend_port }}
          FRONTEND_PORT: ${{ steps.config.outputs.frontend_port }}
          BRANCH_NAME: ${{ github.ref_name }}
          BACKEND_CHANGED: ${{ needs.detect-changes.outputs.backend }}
          FRONTEND_CHANGED: ${{ needs.detect-changes.outputs.frontend }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          command_timeout: 30m
          envs: BACKEND_IMAGE,FRONTEND_IMAGE,DEPLOY_PATH,ENV_NAME,BACKEND_PORT,FRONTEND_PORT,BRANCH_NAME,BACKEND_CHANGED,FRONTEND_CHANGED,GITHUB_TOKEN,GITHUB_ACTOR
          script: |
            cd $DEPLOY_PATH
            chmod +x deploy.sh
            ./deploy.sh
